<?xml version="1.0" encoding="utf-8"?>
<Node xmlns="com.dbi.cat.view.workspace.*" 
	xmlns:mx="http://www.adobe.com/2006/mxml" 
	xmlns:components="com.dbi.cat.view.components.*"
	implements="com.dbi.cat.view.workspace.ILayoutInfoItem"
	width="400" height="300" xmlns:vo="com.dbi.cat.vo.*"
	editWindowHeight="{showAddin ? 450 : 370}"
	editWindowWidth="380"
	displayIcon="{couponIcon}"
	workspaceIcon="{couponIcon}"
	x="{nodeVO.layoutInfo.x}"
	y="{nodeVO.layoutInfo.y}"
	label="Coupon"
	creationComplete="init()">
	<mx:Script>
		<![CDATA[
			import com.dbi.cat.common.constants.CampaignMode;
			import com.dbi.cat.common.constants.EntryPointType;
			import com.dbi.cat.common.vo.CouponNodeVO;
			import mx.events.ChildExistenceChangedEvent;
			import com.dbi.cat.common.vo.ClientVO;
			import com.dbi.cat.common.vo.CampaignVO;
			import com.dbi.cat.common.vo.MessageVO;
			import com.dbi.cat.common.vo.LayoutInfoVO;
			
			
			[Bindable(event="nodeUpdate")]
			public function get couponVO():CouponNodeVO
			{
				return editNodeVO as CouponNodeVO;
			}
			public function set couponVO(c:CouponNodeVO):void
			{
				nodeVO = c;
			}
			public function get layoutInfo():LayoutInfoVO
			{
				return couponVO.layoutInfo;
			}
			public function set layoutInfo(info:LayoutInfoVO):void
			{
				couponVO.layoutInfo = info;
			}
			public function get voUID():String
			{
				return couponVO.uid;
			}
			
			override public function get valid():Boolean
			{
				return couponVO != null && couponVO.valid;
			}
			
			private function get maxCharacters():Number
			{
				return EntryPointType.getMaxCharacters(workspace.campaign.type);
			}
			
			// Addin message of current campaign
			private var _addInMessage:String = "";
			[Bindable]
			public function get addInMessage():String
			{
				return _addInMessage;
			}
			public function set addInMessage(value:String):void
			{
				_addInMessage = value;
				dispatchEvent(new Event("changeAddInMessage"));
			}
			
			/**
			 * Initialize on creation complete
			 */
			private function init():void
			{
				updateAvailableMessage();
				AvailableCharCount. visible = maxCharacters != Number.POSITIVE_INFINITY;
				UnavailableCharCount. visible = maxCharacters != Number.POSITIVE_INFINITY;
			}
			
			private function updateAvailableMessage():void
			{
				// Update entered text
				couponVO.availableMessage = AvailableMessage.text;
				
				// Replace tokens
				var reg:RegExp = new RegExp("{.*?}", "/g");
				couponVO.availableMessage = couponVO.availableMessage.replace(reg, couponCodeToken);
				
				// Remove characters that are above the max length
				while (availableCharacterCount > maxCharacters)
				{
					couponVO.availableMessage = couponVO.availableMessage.substring(0, couponVO.availableMessage.length - 1);
				}
				dispatchEvent(new Event("availableCharacterUpdate"));
			}
			private function updateUnavailableMessage():void
			{
				couponVO.unavailableMessage = UnavailableMessage.text;
				if (unavailableCharacterCount > maxCharacters)
				{
					couponVO.unavailableMessage = couponVO.unavailableMessage.substring(0, maxCharacters - addInMessage.length);
				}
				dispatchEvent(new Event("unavailableCharacterUpdate"));
			}
			
			private function setInfiniteRedemptions():void
			{
				if (InfiniteRedemptions.selected)
					couponVO.maxRedemptions = CouponNodeVO.INFINITE_REDEMPTION_COUNT;
				else
					couponVO.maxRedemptions = 0;
			}
			private function setInfiniteCoupons():void
			{
				if (InfiniteCoupons.selected)
					couponVO.maxCoupons = CouponNodeVO.INFINITE_COUPONS_COUNT;
				else
					couponVO.maxCoupons = 0;
			}
			private function changeCodeType():void
			{
				if (CouponType.selection == RandomCode)
					couponVO.couponCode = null;
				else
					couponVO.couponCode = "";
				updateAvailableMessage();
			}
			private function changeStaticCouponCode():void
			{
				couponVO.couponCode = StaticCodeValue.text;
				updateAvailableMessage();
			}
			private function get couponCodeToken():String
			{
				var ret:String = CouponNodeVO.START_COUPON_CODE;
				if (couponVO.couponCode == null)
					ret += CouponNodeVO.RANDOM_CODE_LENGTH + "_CHAR_CODE";
				else
					ret += StaticCodeValue.text;
				ret += CouponNodeVO.END_COUPON_CODE;
				return ret;
			}
			
			[Bindable(event="changeAddInMessage")]
			[Bindable(event="unavailableCharacterUpdate")]
			private function get unavailableCharacterCount():Number
			{
				var ret:Number = addInMessage == null ? 0 : addInMessage.length;
				if (couponVO != null &&
					couponVO.unavailableMessage != null)
				{
					ret += couponVO.unavailableMessage.length;
				}
				return ret;
			}
			
			[Bindable(event="changeAddInMessage")]
			[Bindable(event="availableCharacterUpdate")]
			private function get availableCharacterCount():Number
			{
				var ret:Number = addInMessage == null ? 0 : addInMessage.length;
				if (couponVO != null &&
					couponVO.availableMessage != null)
				{
					ret += couponVO.availableMessage.length;
					
					// Correct count for merged coupon codes
					if (couponVO.availableMessage.indexOf(couponCodeToken) > -1)
					{
						// Get coupone matches
						var reg:RegExp = new RegExp(couponCodeToken, "/g");
						var matchCount:Number = couponVO.availableMessage.match(reg).length;
						
						// Subtract coupon token lengths
						ret -= couponCodeToken.length * matchCount;
						
						// Add in length of merged coupons
						if (couponVO.couponCode == null)
							ret += (CouponNodeVO.RANDOM_CODE_LENGTH * matchCount);
						else
							ret += (couponVO.couponCode.length * matchCount);
					}
				}
				return ret;
			}
			
			[Bindable(event="changeAddInMessage")]
			private function get showAddin():Boolean
			{
				return addInMessage != null &&
					addInMessage.length > 0;
			}
		]]>
	</mx:Script>
	<editContent>
		<mx:Form right="0" left="0" top="0" bottom="0" 
			paddingLeft="5" paddingRight="5" paddingBottom="5" paddingTop="5">
			<mx:FormItem label="Title" width="100%">
				<mx:TextInput id="Title" width="225"
					text="{couponVO.name}"
					change="{couponVO.name = Title.text}" />
			</mx:FormItem>
			<mx:FormItem label="Max Coupons"
				enabled="{workspace.campaign.mode != CampaignMode.TEMPLATE}">
				<mx:HBox width="100%">
					<mx:TextInput id="MaxCoupons" width="80"
						restrict="[0-9]"
						text="{couponVO.maxCoupons}"
						change="{couponVO.maxCoupons = new Number(MaxCoupons.text)}"
						visible="{couponVO.maxCoupons != CouponNodeVO.INFINITE_COUPONS_COUNT}"
						includeInLayout="{couponVO.maxCoupons != CouponNodeVO.INFINITE_COUPONS_COUNT}" />
					<mx:CheckBox id="InfiniteCoupons"
						label="Infinite"
						selected="{couponVO.maxCoupons == CouponNodeVO.INFINITE_COUPONS_COUNT}"
						change="{setInfiniteCoupons()}" />
				</mx:HBox>
			</mx:FormItem>
			<mx:FormItem label="Max Redemptions"
				enabled="{workspace.campaign.mode != CampaignMode.TEMPLATE}">
				<mx:HBox width="100%">
					<mx:TextInput id="MaxRedemptions" width="80"
						restrict="[0-9]"
						text="{couponVO.maxRedemptions}"
						change="{couponVO.maxRedemptions = new Number(MaxRedemptions.text)}"
						visible="{couponVO.maxRedemptions != CouponNodeVO.INFINITE_REDEMPTION_COUNT}"
						includeInLayout="{couponVO.maxRedemptions != CouponNodeVO.INFINITE_REDEMPTION_COUNT}" />
					<mx:CheckBox id="InfiniteRedemptions"
						label="Infinite"
						selected="{couponVO.maxRedemptions == CouponNodeVO.INFINITE_REDEMPTION_COUNT}"
						change="{setInfiniteRedemptions()}" />
				</mx:HBox>
			</mx:FormItem>
			<mx:FormItem label="Coupon Code"
				enabled="{workspace.campaign.mode != CampaignMode.TEMPLATE}">
				<mx:HBox width="100%">
					<mx:RadioButtonGroup id="CouponType"
						change="changeCodeType()" />
					<mx:RadioButton id="RandomCode"
						label="Random"
						group="{CouponType}"
						selected="{couponVO.couponCode == null}" />
					<mx:RadioButton id="StaticCode"
						label="Static"
						group="{CouponType}"
						selected="{couponVO.couponCode != null}" />
					<mx:TextInput id="StaticCodeValue"
						width="80"
						text="{couponVO.couponCode}"
						change="changeStaticCouponCode()"
						visible="{StaticCode.selected}" />
				</mx:HBox>
			</mx:FormItem>
			<mx:FormItem label="Unavailable Date"
				enabled="{workspace.campaign.mode != CampaignMode.TEMPLATE}">
				<mx:DateField id="UnavailableDate"
					editable="true"
					selectedDate="{couponVO.unavailableDate}"
					change="{couponVO.unavailableDate = UnavailableDate.selectedDate}" />
			</mx:FormItem>
			<mx:FormItem label="Available" required="true" width="100%" 
				enabled="{workspace.campaign.mode != CampaignMode.TEMPLATE}">
					<mx:TextArea id="AvailableMessage"  width="225" height="60"
						styleName="couponMessage"
						text="{couponVO.availableMessage}" 
						change="updateAvailableMessage()"/>
			</mx:FormItem>
			<mx:FormItem id="AvailableCharCount"
				enabled="{workspace.campaign.mode != CampaignMode.TEMPLATE}">
				<mx:Label text="{availableCharacterCount + '/' + maxCharacters + ' chars'}" />
			</mx:FormItem>
			<mx:FormItem label="Unavailable" 
				enabled="{workspace.campaign.mode != CampaignMode.TEMPLATE}">
				<mx:TextArea id="UnavailableMessage" width="225" height="60"
					text="{couponVO.unavailableMessage}"
					change="updateUnavailableMessage()"  />
			</mx:FormItem>
			<mx:FormItem id="UnavailableCharCount"
				enabled="{workspace.campaign.mode != CampaignMode.TEMPLATE}">
				<mx:Label text="{unavailableCharacterCount + '/' + maxCharacters + ' chars'}" />
			</mx:FormItem>
			<mx:FormItem label="Add In" visible="{showAddin}" includeInLayout="{showAddin}"
				enabled="{workspace.campaign.mode != CampaignMode.TEMPLATE}">
				<mx:TextArea id="AddIn" width="200" height="70"
					text="{addInMessage}"
					editable="false" />
			</mx:FormItem>
		</mx:Form>
	</editContent>
</Node>
